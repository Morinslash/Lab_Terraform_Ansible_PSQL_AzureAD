# Ansible Playbook for automatized integration of Azure PostgreSQL with Azure AD

## Tools

- Ansible
- Docker

## Docker

[dockerfile](dockerfile) will build a container image with all of the required dependencies of Ansible, Azure Cli and PostgreSQL Collection

Build image with locally

```bash
docker build -t ansible-image:v1.0 .
```

To run a image locally:

```bash
docker run -it --rm -v ${PWD}:/src -w /src --entrypoint /bin/bash ansible-azure:v1
```

This command will automatically enter to the shell of the container and mount the current path into the container. 

The `--rm` flag will remove the container on exiting the shell.

## The general overview of setup

Both playbook automatize the integration of PostgreSQL with Azure AD and the goal of them is to:
- Create and/or configure PostgreSQL instance to control access to databases. 
- For each database create an integrated Role with Azure AD Group, members of this group will be able connect to the database server using **group name** and token generated with `az cli`
- For each database create an Role with autogenerate password that would be stored automatically in the **Azure Key Vault**
- Both Developers Role and Application role will have *SELECT*, *INSERT*, *UPDATE*, *DELETE* permission within database to operate on records

## Know limitations

Azure provides integration with Azure AD for PostgreSQL servers so users, group, service principals and managed identities can leverage the Azure AD system to obtain *token* that can be used as a password to authenticate to the server.

This doesn't mean we can use our AAD credentials directly but we have to generate an access token first using `az cli` command:

```bash
az account get-access-token --resource-type oss-rdbms --query accessToken --output tsv
```

Further more if we do not integrate directly users and service principals but groups instead as a **username** to connect to the instance we should use **Azure AD group name**.

### Single Server

Azure PostgreSQL Single Server doesn't allow Service Principals to have full administrator permissions even if they belong to the same group as regular Azure AD Users. Significant one for this PoC is the limitation of not being able to grant other roles **azure_ad_user** role, which have impact on automatization possibilities as we have to provide a *token* for each run of the playbook generated by the **Azure AD User**. This restriction is removed in Flexible Server.

## Prerequisites

For both Playbooks to run we will need:

- Azure PostgreSQL instances, respectively Flexible or Single Server
  - Single Server with Azure Directory Admin integrated with AzureAD Group
  - Flexible Server with both PostgreSQL and Azure AD authentication
- Azure KeyVault for storing passwords after creating Application roles
- Service Principals with access to
  - KeyVault to create secrets
  - Directory Readers permissions to fetch Groups ID from AzureAD tenant (Flexible Server)
- Az Cli installed

## Other

Please keep in mind that the process of automatization is different for Single Server and Flexible Server instance. Check Official Documentation for details.

In the Single Server implementation Ansible is not responsible for creating Databases inside the instance. The script is fetching instance information and filtering out databases names to configure.

In the Flexible Server implementation Ansible will create the database that we can pass as a variables into the script for full control of the automatization. 

## Environmental Variables

For required variables check:

[Single Server](./src/ansible/single-server/var_file.example.yml)
[Flexible Server](./src/ansible/flexible-server/var_file.example.yml) and [Databases Names](./src/ansible/flexible-server/db_names.yml)

## Running Ansible Playbook over `cli` and providing env variables (example)

```bash
ansible-playbook playbook.yml -e '{
  "azconfig": {
    "client_id": "<sp-client-id>", 
    "secret": "<sp-secret>", 
    "subscription_id": "<sp-subscription>-id", 
  },
  "database_config": {
    "login_host": "<postgres-host>", 
    "login_user": "<admin-group-name>@<server-name>", 
    "login_password": "<az-cli-token>", 
    "owner": "<admin-group-name>"
  },
  "keyvault_name": "<keyvault-name>"
}'
```

## GitHub Actions example workflow

[test-script](./src/ansible/test-script/) contains simple PoC playbook that is printing back provided environment variable. The purpose was to test the [workflow](.github/workflows/test-workflow.yml) that could be run manually in the GitHub Actions with a required variable that must be provided on dispatching action. 

This workflow is using a *service container* with preinstalled all of the dependencies and  mounted runner workspace. After checkout of repo into runner all files are availabe inside the container so we can execute the Ansible playbook and pass variables with command:

```bash
docker exec <name-of-service-container> ansible-playbook <path/to/playbook> -e "<variables>"
``` 

## Official Documentation

### Single Server
[Use Azure Active Directory for authentication with PostgreSQL](https://learn.microsoft.com/en-us/azure/postgresql/single-server/how-to-configure-sign-in-azure-ad-authentication)

[Use Azure Active Directory for authenticating with PostgreSQL](https://learn.microsoft.com/en-us/azure/postgresql/single-server/concepts-azure-ad-authentication)

### Flexible Server
[Azure Active Directory Authentication with PostgreSQL Flexible Server](https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/concepts-azure-ad-authentication?source=recommendations)

[Use Azure AD for authentication with Azure Database for PostgreSQL](https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/how-to-configure-sign-in-azure-ad-authentication?source=recommendations)

[Manage Azure Active Directory roles in Azure Database for PostgreSQL](https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/how-to-manage-azure-ad-users)

### Ansible PostgreSQL collection

[Community.Postgresql](https://docs.ansible.com/ansible/latest/collections/community/postgresql/index.html)
